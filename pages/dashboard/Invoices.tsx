import React, { useState, useEffect, useRef, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { FileText, Download, CheckCircle2, AlertCircle, CreditCard, Loader2, Upload, ScanLine, X, Calendar, DollarSign, Zap } from 'lucide-react';
import { useAuth } from '../../contexts/AuthContext';
import { SaaSService } from '../../services/supabase';
import { OCRService } from '../../services/ocrService';
import { Invoice, OCRResult } from '../../types';
import { useNavigate } from 'react-router-dom';
const Invoices: React.FC = () => {
  const { user } = useAuth();
  const [invoices, setInvoices] = useState<Invoice[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'pending' | 'paid'>('all');
  const navigate = useNavigate();
  const [isOCRModalOpen, setIsOCRModalOpen] = useState(false);
  const [isProcessingOCR, setIsProcessingOCR] = useState(false);
  const [ocrResult, setOCRResult] = useState<OCRResult | null>(null);
  const [scanProgress, setScanProgress] = useState(0);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const loadData = useCallback(async () => { if (!user) return; const data = await SaaSService.getAllInvoices(user.id); setInvoices(data); setLoading(false); }, [user]);
  useEffect(() => { if (user) loadData(); }, [user, loadData]);
  const filteredInvoices = invoices.filter(inv => { if (filter === 'all') return true; return inv.status === filter; });
  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;
    setIsOCRModalOpen(true); setIsProcessingOCR(true); setOCRResult(null); setScanProgress(0);
    const progressInterval = setInterval(() => { setScanProgress(prev => { if (prev >= 90) return prev; return prev + Math.random() * 10; }); }, 500);
    try { const result = await OCRService.processInvoice(file); clearInterval(progressInterval); setScanProgress(100); setTimeout(() => { setOCRResult(result); setIsProcessingOCR(false); }, 800); } catch (_error) { void _error; clearInterval(progressInterval); setIsProcessingOCR(false); setIsOCRModalOpen(false); alert("Erro ao processar fatura. Tente novamente."); }
    if (fileInputRef.current) fileInputRef.current.value = '';
  };
  const handleConfirmInvoice = async () => {
      setIsOCRModalOpen(false);
      const newInvoiceMock: Invoice = { id: Math.floor(Math.random() * 10000), unit_id: 1, month: new Date().toISOString(), consumption_kwh: Math.floor((ocrResult?.extractedValue || 500) / 0.8), total_value: ocrResult?.extractedValue || 0, savings_estimated: (ocrResult?.extractedValue || 0) * 0.15, status: 'pending', consumer_units: { name: 'Nova Fatura (Scan)' } };
      setInvoices([newInvoiceMock, ...invoices]);
  };
  const formatMoney = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  const formatDate = (dateStr: string) => new Date(dateStr).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  return (
    <div className="space-y-6 relative">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"> <div> <h1 className="text-2xl font-bold text-white">Minhas Faturas</h1> <input type="text" placeholder="Buscar fatura por mês ou valor" aria-label="Search invoices" title="Search invoices" className="mt-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-emerald-500 outline-none" /> <p className="text-slate-400 text-sm mt-2">Gerencie o histórico e pagamentos de todas as unidades.</p> </div> <div className="flex flex-wrap gap-2 items-center"> <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept="image/*,.pdf" className="hidden" /> <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold rounded-lg border border-slate-700 transition-all shadow-lg"> <Upload className="w-4 h-4 text-emerald-400" /> Scanear Fatura (OCR) </button> <div className="h-6 w-px bg-slate-800 mx-2 hidden md:block"></div> <button onClick={() => setFilter('all')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${filter === 'all' ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}>Todas</button> <button onClick={() => setFilter('pending')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${filter === 'pending' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}>Pendentes</button> <button onClick={() => setFilter('paid')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${filter === 'paid' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}>Pagas</button> </div> </div>
      <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-xl">
        {loading ? ( <div className="p-12 flex justify-center"><Loader2 className="w-8 h-8 text-emerald-500 animate-spin" /></div> ) : filteredInvoices.length === 0 ? ( <div className="p-12 text-center text-slate-500"> <FileText className="w-12 h-12 mx-auto mb-4 opacity-50" /> <p>Nenhuma fatura encontrada para este filtro.</p> <button onClick={() => fileInputRef.current?.click()} className="mt-4 text-emerald-500 hover:underline text-sm font-bold"> Fazer upload da primeira fatura </button> </div> ) : ( <div className="overflow-x-auto"> <table className="w-full text-left"> <thead> <tr className="bg-slate-950/50 border-b border-slate-800 text-slate-400 text-xs uppercase tracking-wider"> <th className="p-4 font-semibold">Mês de Referência</th> <th className="p-4 font-semibold">Unidade Consumidora</th> <th className="p-4 font-semibold">Consumo (kWh)</th> <th className="p-4 font-semibold">Valor Total</th> <th className="p-4 font-semibold">Economia Est.</th> <th className="p-4 font-semibold">Status</th> <th className="p-4 font-semibold text-right">Ações</th> </tr> </thead> <tbody className="divide-y divide-slate-800"> {filteredInvoices.map((invoice, idx) => ( <motion.tr key={invoice.id} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.05 }} className="group hover:bg-slate-800/50 transition-colors"> <td className="p-4 text-white font-medium capitalize flex items-center gap-3"> <div className="p-2 bg-slate-800 rounded-lg text-emerald-500"><FileText className="w-4 h-4" /></div> {formatDate(invoice.month)} </td> <td className="p-4 text-slate-300">{invoice.consumer_units?.name}</td> <td className="p-4 text-slate-300 font-mono">{invoice.consumption_kwh.toLocaleString()}</td> <td className="p-4 text-white font-bold">{formatMoney(invoice.total_value)}</td> <td className="p-4 text-emerald-400 font-medium">+{formatMoney(invoice.savings_estimated)}</td> <td className="p-4"> <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold uppercase ${ invoice.status === 'paid' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : invoice.status === 'pending' ? 'bg-orange-500/10 text-orange-400 border border-orange-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20' }`}> {invoice.status === 'paid' ? <CheckCircle2 className="w-3 h-3" /> : <AlertCircle className="w-3 h-3" />} {invoice.status === 'paid' ? 'Pago' : invoice.status === 'pending' ? 'Pendente' : 'Atrasado'} </span> </td> <td className="p-4 text-right"> <div className="flex items-center justify-end gap-2"> <button className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all" title="Baixar PDF"> <Download className="w-4 h-4" /> </button> {invoice.status === 'pending' && ( <button onClick={() => navigate('/app/financeiro', { state: { invoiceId: invoice.id } })} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold rounded-lg transition-all shadow-lg shadow-emerald-500/20"> <CreditCard className="w-3 h-3" /> Pagar </button> )} </div> </td> </motion.tr> ))} </tbody> </table> </div> )}
      </div>
      <AnimatePresence> {isOCRModalOpen && ( <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm"> <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden relative"> <button onClick={() => setIsOCRModalOpen(false)} className="absolute top-4 right-4 text-slate-400 hover:text-white z-10" title="Close"><X className="w-5 h-5"/></button> <div className="p-6 border-b border-slate-800 bg-slate-800/50"> <h2 className="text-xl font-bold text-white flex items-center gap-2"> <ScanLine className="w-6 h-6 text-emerald-400" /> Scanner Inteligente (OCR) </h2> </div> <div className="p-8"> {isProcessingOCR ? ( <div className="text-center py-8 space-y-6"> <div className="relative w-24 h-32 mx-auto bg-slate-800 border border-slate-700 rounded-lg overflow-hidden"> <motion.div animate={{ top: ['0%', '100%', '0%'] }} transition={{ duration: 2, repeat: Infinity, ease: "linear" }} className="absolute left-0 w-full h-1 bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.8)]" /> <div className="absolute inset-0 flex items-center justify-center"> <FileText className="w-10 h-10 text-slate-600" /> </div> </div> <div> <h3 className="text-lg font-bold text-white mb-2">Analisando Documento...</h3> <div className="w-full bg-slate-800 h-2 rounded-full overflow-hidden max-w-xs mx-auto"> <div className="h-full bg-emerald-500 transition-all duration-300" style={{ width: `${scanProgress}%` }} ></div> </div> <p className="text-xs text-slate-500 mt-2">Extraindo valores, datas e códigos de barras.</p> </div> </div> ) : ( <div className="space-y-6"> <div className="flex items-center gap-3 bg-emerald-500/10 border border-emerald-500/20 p-4 rounded-xl"> <CheckCircle2 className="w-6 h-6 text-emerald-500" /> <div> <h3 className="font-bold text-emerald-400">Leitura Concluída</h3> <p className="text-xs text-slate-400">Confiança da IA: <span className="text-white font-mono">{Math.round(ocrResult?.confidence || 0)}%</span></p> </div> </div> <div className="grid grid-cols-2 gap-4"> <div className="bg-slate-950 p-4 rounded-xl border border-slate-800"> <label className="text-xs text-slate-500 uppercase font-bold flex items-center gap-1 mb-2"><DollarSign className="w-3 h-3"/> Valor Total</label> <div className="text-xl font-bold text-white">{formatMoney(ocrResult?.extractedValue || 0)}</div> </div> <div className="bg-slate-950 p-4 rounded-xl border border-slate-800"> <label className="text-xs text-slate-500 uppercase font-bold flex items-center gap-1 mb-2"><Calendar className="w-3 h-3"/> Vencimento</label> <div className="text-xl font-bold text-white">{ocrResult?.extractedDate || 'N/A'}</div> </div> </div> <div className="bg-slate-950 p-4 rounded-xl border border-slate-800"> <label className="text-xs text-slate-500 uppercase font-bold flex items-center gap-1 mb-2"><Zap className="w-3 h-3"/> Texto Identificado (Trecho)</label> <p className="text-xs text-slate-400 font-mono leading-relaxed line-clamp-3"> {ocrResult?.text} </p> </div> <button onClick={handleConfirmInvoice} className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition-all"> Confirmar e Adicionar Fatura </button> </div> )} </div> </motion.div> </div> )} </AnimatePresence>
    </div>
  );
};
export default Invoices;